(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/home/liveHome/index"],{1850:function(e,s,n){"use strict";n.r(s);var o=n("8ab2"),t=n.n(o);for(var i in o)"default"!==i&&function(e){n.d(s,e,(function(){return o[e]}))}(i);s["default"]=t.a},"53a3":function(e,s,n){"use strict";var o={uIcon:function(){return n.e("uview-ui/components/u-icon/u-icon").then(n.bind(null,"142f"))},uPopup:function(){return n.e("uview-ui/components/u-popup/u-popup").then(n.bind(null,"6fed"))}},t=function(){var e=this,s=e.$createElement;e._self._c;e._isMounted||(e.e0=function(s){e.is_input=!0},e.e1=function(s){e.is_input=!1},e.e2=function(s){e.buyVisible=!1})},i=[];n.d(s,"b",(function(){return t})),n.d(s,"c",(function(){return i})),n.d(s,"a",(function(){return o}))},"8ab2":function(s,n,o){"use strict";(function(s){Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;var t=o("d508"),i=a(o("3a3c"));function a(e){return e&&e.__esModule?e:{default:e}}var r=function(){o.e("components/room/CarList").then(function(){return resolve(o("0c0e"))}.bind(null,o)).catch(o.oe)},d=function(){o.e("components/room/More").then(function(){return resolve(o("d222"))}.bind(null,o)).catch(o.oe)},c=function(){o.e("components/room/BuyPopup").then(function(){return resolve(o("2223"))}.bind(null,o)).catch(o.oe)},u=function(){Promise.all([o.e("common/vendor"),o.e("components/uni-canvas/uni-canvas")]).then(function(){return resolve(o("ce88"))}.bind(null,o)).catch(o.oe)},l="",m=wx.getBackgroundAudioManager(),f=0,g="",h={EVERYONE:1,SELFROOMUPPER:2,ONLYUPPER:3,SELFROOM:4},I={TIPS:100,PICS:1,LIVEEND:2,LIVEPASUE:3,LIVERESUME:4,LIVEUPDATE:5,UPDATEDPRODUCTS:6,BANSHARE:7,MSGOPEN:8,PASSWD:9,VOTE:10,CREATEORDER:11,LIKE:12,ADDCART:13,PAYOK:14,LIVEOPEN:15,SHAREROOM:16,HOTP:17,INTRO:18,CANCELHOTP:19,BLOCK:20,KICKOUT:21,FREE:22,JOIN:23,QUIT:24},p={provide:function(){return{closeGoodsPop:this.closeGoodsPop}},components:{"car-list":r,"foot-more":d,"buy-Popup":c,"show-image":u},data:function(){return{headAttr:{top:44},zanState:!1,liveMsg:"",live_src:"",carVisible:!1,moreVisible:!1,buyVisible:!1,banShare:!1,goodsInfo:{},is_active:!1,is_input:!1,share_status:!1,tolast:"",userInputWord:"",goodsList:[],messages:[],liveID:"",canITalk:!0,userInfo:{},liveInfo:{},praiseCount:0,address:{}}},onLoad:function(e){var n=this;this.setHeight(),s.getSystemInfo({success:function(e){n.windowHeight=e.windowHeight}}),this.liveID=e.shop_id,this.userInfo=JSON.parse(s.getStorageSync("userInfo")),console.log("userInfo",this.userInfo),console.log("直播间id",this.liveID)},onUnload:function(){var e=this;getApp().im&&getApp().im.leaveRoom(e.liveInfo.im_userid),e.sendWSCmd(I.QUIT),l&&clearInterval(l),m.pause()},onReady:function(){var e=this;this.getRoomData(this.liveID),setTimeout((function(){e.sendWSCmd(I.JOIN),(0,t.roomGoodsApi)({currentPage:0,pageSize:10,shop_id:parseInt(e.liveID)}).then((function(s){s.msg||(e.goodsList=s.list)}))}),2e3),getApp().msgCache=[],getApp().curMsgIndex=0,wx.getImageInfo({src:"https://mp.starfox.cn:9008/api/master/user/genQrCode",success:function(e){s.setStorageSync("qrCode",e.path)}})},created:function(){},onShow:function(){this.address=JSON.parse(s.getStorageSync("address")),console.log(this.address),console.log("-------------------------------")},methods:{select_adress:function(){s.navigateTo({url:"../../user/address/index"})},show_share_pic:function(){this.share_status=!this.share_status},tapZan:function(){this.zanState=!this.zanState;var e=this;this.manualPraise=!0,this.praiseCount=++this.praiseCount,++f,g||(g=setInterval((function(){if(f){var s=f;e.submitClicks(s),f=0}else clearInterval(g),g=""}),500))},submitClicks:function(e){console.log("成功提交点赞数：",e),this.vote_num=e,this.sendWSCmd(I.VOTE),this.praiseCount=0},open_share:function(){this.share_status=!this.share_status},close_share_image:function(){this.share_status=!1},goBackVideo:function(){console.log("----"),s.navigateTo({url:"../../pages/square/backVideo/backVideo"})},goHomePage:function(e){s.navigateTo({url:"../../user/homePage/index?id="+e.shop_id+"&avater="+e.avatar})},goBack:function(){s.navigateBack()},more_product:function(){this.carVisible=!0},addGoods:function(e){this.goodsInfo=e,this.buyVisible=!0},more_tool:function(){this.moreVisible=!0},say_anything:function(){this.is_input=!0},close_more_tool:function(){this.share_status=!1},scrollToBottom:function(){this.tolast="item"+this.messages.length},attention:function(){this.is_active=!0;var e={shop_id:this.liveID};(0,t.follow)(e).then((function(e){}))},getRoomData:function(e){var s=this;if(e>0){e=parseInt(e);var n={shop_id:e};(0,t.enterRoom)(n).then((function(e){console.log("enterRoom_res",e),s.live_src=e.live_url,s.liveInfo=e,s.liveSrc=e.live_url,s.is_active=e.followed,s.liveTime=2e3,s.extra=void 0,s.parentId=e.parent_id,s.isConnect()}))}},error:function(e){},statechange:function(e){},sendMsg:function(){var e=this,s={cmdId:111};if(cmdId!=I.TIPS&&cmdId!=I.PICS&&cmdId!=I.BANSHARE&&cmdId!=I.MSGOPEN){cmdId==I.PASSWD?s={password:this.password}:cmdId==I.LIVERESUME?s={cmd:!0}:cmdId==I.LIVEPASUE?s={cmd:!0}:cmdId==I.LIVEEND?s={cmd:!0}:cmdId==I.LIVEOPEN?s={cmd:!0}:cmdId==I.VOTE&&(s={voteNum:this.vote_num});var n={appId:e.liveInfo.shop_id,userId:e.userInfo.user_id,nickName:e.userInfo.nick_name,whoCanSee:e.getMsgScope(1,cmdId),cmdId:cmdId,message:JSON.stringify(s)},o=getApp().im,t=JSON.stringify(n),a={sender:e.liveInfo.im_userid,receiver:e.liveInfo.shop_id,content:t};e.parentId&&e.parentId>0&&(a={sender:e.liveInfo.im_userid,receiver:e.parentId,content:t}),o&&o.connectState==i.default.STATE_CONNECTED&&o.sendRoomMessage(a)}},isConnect:function(){if(console.log("是否连接"),this.extra){var s=JSON.parse(this.extra);s&&(s.mprData.x+100>e.data.Swidth&&(s.mprData.x=e.data.Swidth-100),this.banShare=s.banShare,this.msgOpen=s.msgOpen,this.barCodeImg=s.barCodeImg,this.praiseCount=s.praiseCount||201)}this.showLoading=!1,console.log("im",getApp().im),!getApp().im&&this.liveInfo&&this.liveInfo.shop_id&&!this.liveInfo.liveEnd?this.startConnect(this.liveInfo.im_access_token,this.liveInfo.shop_id):getApp().im?this.parentId&&this.parentId>0?getApp().im.enterRoom(this.parentId):getApp().im.enterRoom(this.liveInfo.shop_id):console.log("2222222")},startConnect:function(e,s){var n=this,o=this;function t(e){var s=parseInt(e.cmdId),n=JSON.parse(e.message);if(console.log("startConnect cmdID",s),s==I.VOTE)o.audience_vote=o.audience_vote+n.voteNum;else if(s==I.LIVEEND)o.parentId||(o.liveInfo.liveEnd=!0,o.liveBreak=!1,o.praiseCount=n.praiseCount,o.liveInfo.audiences=n.userCount,o.liveTime=n.liveTime);else if(s==I.LIVEPASUE)o.liveBreak=!0;else if(s==I.LIVERESUME)o.liveBreak=!1;else if(s==I.BANSHARE)o.banShare=n.cmd;else if(s==I.MSGOPEN){t=n.cmd?"我关闭了聊天限制，你所发的消息，全部直播间的人可见！":"我开启了聊天限制，你所发的消息，只有我能看见！",console.log("addM1"),o.addMessage({msgIndex:0,is_anchor:1,headimg:"",nickname:e.nickName+": ",message:t})}else if(s==I.TIPS)n.x+100>o.Swidth&&(n.x=o.Swidth-100),o.mprData=n;else if(s==I.PICS)n.x+100>o.Swidth&&(n.x=o.Swidth-100),o.barCodeImg=n;else if(s==I.LIVEOPEN)o.liveInfo.liveEnd=!1,o.liveBreak=!1;else if(s==I.LIKE)o.addCustomMessage({url:"entry-room-steamer-info",show_message:e.nickName+": 关注了主播",total_time:2});else if(s==I.ADDCART)o.addCustomMessage({url:"live-room-goods-addcar-info",show_message:e.nickName+": 加入了购物车",total_time:2});else if(s==I.PAYOK)o.addCustomMessage({url:"live-room-goods-addorder-info",show_message:e.nickName+": 购买了商品",total_time:2});else if(s==I.SHAREROOM)o.addCustomMessage({url:"live-room-share",show_message:e.nickName+": 分享了直播间",total_time:2});else if(s==I.CREATEORDER)o.addCustomMessage({url:"live-room-goods-addorder-info",show_message:e.nickName+": 开始下单",total_time:2});else if(s==I.UPDATEDPRODUCTS)o.addCustomMessage({url:"live-room-goods-addorder-info",show_message:"直播间的商品更新了！！！",total_time:2,isMaster:e.isMaster});else if(s==I.HOTP)o.showHotGoods=!0,o.hotGoods=n;else if(s==I.CANCELHOTP)o.showHotGoods=!1;else if(s==I.INTRO)o.getIntroGoods();else if(s==I.BLOCK){var t=n.userName+"已被管理员"+n.blockmsg,i="系统: ";o.userInfo.user_id==n.toId&&(t="你已被管理员"+n.blockmsg+"如果你多次被禁言，你的账号将会暂停服务。",i="系统: 【重要】",o.canITalk=!1),console.log("addM2"),o.addMessage({msgIndex:0,is_anchor:0,headimg:"",nickname:i,message:t})}else if(s==I.FREE)o.userInfo.user_id==n.toId&&(console.log("addM3"),o.addMessage({msgIndex:0,is_anchor:0,headimg:"",nickname:"系统: 【重要】",message:"你已被管理员解除禁言限制！如果你多次被禁言，你的账号将会暂停服务。"}));else if(s==I.KICKOUT)if(o.userInfo.user_id==n.toId)o.liveInfo.liveEnd=!0,o.liveBreak=!1,o.praiseCount=n.praiseCount,o.liveInfo.audiences=n.userCount,o.liveTime=n.liveTime,wx.navigateBack();else{t=n.userName+"已被管理员踢出直播间",i="系统: ";console.log("addM4"),o.addMessage({msgIndex:0,is_anchor:0,headimg:"",nickname:i,message:t})}else if(s==I.JOIN){console.log("加入了直播间"),console.log("t-messages",o.messages);var a=e.nickName+": 加入了直播间";if(a==o.join_stor_msg)return;o.join_stor_msg=a,o.addMessage({msgIndex:0,headimg:"",nickname:e.nickName+": ",message:"加入了直播间"}),o.liveInfo.audiences=parseInt(o.liveInfo.audiences)+Math.floor(6*Math.random()+2)}else s==I.QUIT&&(1!=e.isMaster||o.parentId||(o.liveInfo.liveEnd=!0,o.liveBreak=!1),o.liveInfo.audiences=parseInt(o.liveInfo.audiences)-1)}console.log("开启连接方法",e,s);var a="ws.starfox.cn",r=new i.default(a,9003);r.protocol="wss://";var d={handleRoomMessage:function(e){console.log("msg sender:",e.sender," room id:",e.receiver," content:",e.content," timestamp:",e.timestamp);var s="主播",n=JSON.parse(e.content);console.log("接收消息",e),n.cmdId?t(n):(console.log("addM5"),o.addMessage({msgIndex:0,is_anchor:n.isMaster,actor:s,headimg:"",nickname:n.nickName+": ",message:n.message}))},onConnectState:function(e){var s=n;e==i.default.STATE_CONNECTED?(s.sendWSCmd(I.JOIN),console.log("im connected")):e==i.default.STATE_CONNECTING?console.log("im connecting"):e==i.default.STATE_CONNECTFAIL?console.log("im connect fail"):e==i.default.STATE_UNCONNECTED&&console.log("im unconnected")}};r.host=a,r.observer=d,r.accessToken=e,r.start(),console.log("parentId=",o.parentId,"roomId=",s),o.parentId&&o.parentId>0?r.enterRoom(o.parentId):(console.log("33333333"),r.enterRoom(s)),getApp().im=r},sendWSCmd:function(e){var s=this,n={cmdId:111};if(e!=I.TIPS&&e!=I.PICS&&e!=I.BANSHARE&&e!=I.MSGOPEN){e==I.PASSWD?n={password:this.password}:e==I.LIVERESUME?n={cmd:!0}:e==I.LIVEPASUE?n={cmd:!0}:e==I.LIVEEND?n={cmd:!0}:e==I.LIVEOPEN?n={cmd:!0}:e==I.VOTE&&(n={voteNum:this.vote_num});var o={appId:s.liveInfo.shop_id,userId:s.userInfo.user_id,nickName:s.userInfo.nick_name,whoCanSee:s.getMsgScope(1,e),cmdId:e,message:JSON.stringify(n)},t=getApp().im,a=JSON.stringify(o),r={sender:s.liveInfo.im_userid,receiver:s.liveInfo.shop_id,content:a};s.parentId&&s.parentId>0&&(r={sender:s.liveInfo.im_userid,receiver:s.parentId,content:a}),t&&t.connectState==i.default.STATE_CONNECTED&&t.sendRoomMessage(r)}},getMsgScope:function(e,s){return e?s==I.JOIN||s==I.QUIT?h.SELFROOMUPPER:h.ONLYUPPER:h.EVERYONE},startUpdateMsg:function(){var e=this;!this.liveInfo.liveEnd&&this._updateMsg().then((function(){l=setTimeout((function(){e.startUpdateMsg()}),2e3)}))},_updateMsg:function(){var e=this,s=this;return new Promise((function(n){if(!getApp().msgCache.length)return n();if(console.log("messages",e.messages),s.messages.length>=100){var o=e.messages.splice(1,50);e.messages=o}n()}))},sendMessage:function(){console.log("发送1");var e=this,n=this.userInputWord;e.canITalk?n?(e._sendMessage(n),this.userInputWord=""):wx.showToast({title:"输入为空",icon:"none"}):s.showToast({title:"已被禁言",icon:"none"})},_sendMessage:function(e){console.log("发送2");var s=this,n=getApp().im,o={appId:s.liveInfo.shop_id,userId:s.userInfo.user_id,nickName:s.userInfo.nick_name,whoCanSee:s.getMsgScope(0),parentId:s.parentId,spaceName:s.parentId?s.liveInfo.spaceName:"",message:e},t=JSON.stringify(o),a={sender:s.liveInfo.im_userid,receiver:s.liveInfo.shop_id,content:t};s.parentId&&s.parentId>0&&(a={sender:s.liveInfo.im_userid,receiver:s.parentId,content:t}),console.log("connectState=",n.connectState,"STATE_CONNECTED",i.default.STATE_CONNECTED),n.connectState==i.default.STATE_CONNECTED&&(console.log("链接已开启发送消息",a),n.sendRoomMessage(a)),this.inputInfo="",this.inputModalVisible=!1,console.log("addM6"),s.addMessage({msgIndex:0,is_anchor:0,headimg:s.userInfo.avatarUrl,nickname:s.userInfo.nick_name+": ",message:e}),s._updateMsg()},addMessage:function(e){console.log("add new message"),this.messages.push(e),this._updateMsg(),this.scrollToBottom()},addCustomMessage:function(e){var s=this;console.log("addCustom",e);var n=e.show_message,o=(e.total_time,e.member_num),t=e.praise_count;o&&o>this.liveInfo.audiences&&t&&t>this.praiseCount&&n&&!this.data.showUserActionTips&&(console.log("开始添加自定义消息"),this.liveInfo.audiences=o,this.manualPraise=!1,this.praiseCount=1[{url:"live-room-share",type:"share"}].map((function(o){if(e.url===o.url){var t=o;t.message=n,s.userActionTips=t,s.showUserActionTips=!0,setTimeout((function(){s.showUserActionTips=!1}));var i={msgIndex:++getApp().curMsgIndex,is_anchor:e.isMaster||0,headimg:"",nickname:n,message:""};getApp().msgCache.push(i)}})))},closeGoodsPop:function(){this.carVisible=!1,this.buyVisible=!1}}};n.default=p}).call(this,o("543d")["default"])},"9e6c":function(e,s,n){"use strict";(function(e){n("6089");o(n("66fd"));var s=o(n("db9c"));function o(e){return e&&e.__esModule?e:{default:e}}e(s.default)}).call(this,n("543d")["createPage"])},ad63:function(e,s,n){"use strict";var o=n("dd59"),t=n.n(o);t.a},db9c:function(e,s,n){"use strict";n.r(s);var o=n("53a3"),t=n("1850");for(var i in t)"default"!==i&&function(e){n.d(s,e,(function(){return t[e]}))}(i);n("ad63");var a,r=n("f0c5"),d=Object(r["a"])(t["default"],o["b"],o["c"],!1,null,"7deaa7e1",null,!1,o["a"],a);s["default"]=d.exports},dd59:function(e,s,n){}},[["9e6c","common/runtime","common/vendor"]]]);