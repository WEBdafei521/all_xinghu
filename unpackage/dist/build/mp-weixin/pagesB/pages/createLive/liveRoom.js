(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pagesB/pages/createLive/liveRoom"],{"0d61":function(e,t,o){"use strict";var n={uNoticeBar:function(){return o.e("uview-ui/components/u-notice-bar/u-notice-bar").then(o.bind(null,"b8b3"))},uPopup:function(){return o.e("uview-ui/components/u-popup/u-popup").then(o.bind(null,"6fed"))},uIcon:function(){return o.e("uview-ui/components/u-icon/u-icon").then(o.bind(null,"142f"))}},s=function(){var e=this,t=e.$createElement;e._self._c;e._isMounted||(e.e0=function(t){e.MEIVisible=!0},e.e1=function(t){e.footHidden=!0},e.e2=function(t){e.moreVisible=!0},e.e3=function(t){e.footHidden=!1},e.e4=function(t){e.moreVisible=!1},e.e5=function(t){e.OBSVisible=!1})},i=[];o.d(t,"b",(function(){return s})),o.d(t,"c",(function(){return i})),o.d(t,"a",(function(){return n}))},"4d15":function(e,t,o){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=o("2f62"),s=o("d508"),i=r(o("3a3c"));function r(e){return e&&e.__esModule?e:{default:e}}function a(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,n)}return o}function u(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?a(Object(o),!0).forEach((function(t){c(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):a(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function c(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}var l=function(){o.e("components/room/goods").then(function(){return resolve(o("b354"))}.bind(null,o)).catch(o.oe)},d=function(){o.e("pagesB/components/room/More").then(function(){return resolve(o("4cd5"))}.bind(null,o)).catch(o.oe)},f=function(){Promise.all([o.e("common/vendor"),o.e("components/uni-canvas/uni-canvas")]).then(function(){return resolve(o("ce88"))}.bind(null,o)).catch(o.oe)},h=(wx.getBackgroundAudioManager(),0),m=0,p=0,g={EVERYONE:1,SELFROOMUPPER:2,ONLYUPPER:3,SELFROOM:4},v={TIPS:100,PICS:1,LIVEEND:2,LIVEPASUE:3,LIVERESUME:4,LIVEUPDATE:5,UPDATEDPRODUCTS:6,BANSHARE:7,MSGOPEN:8,PASSWD:9,VOTE:10,CREATEORDER:11,LIKE:12,ADDCART:13,PAYOK:14,LIVEOPEN:15,SHAREROOM:16,HOTP:17,INTRO:18,CANCELHOTP:19,BLOCK:20,KICKOUT:21,FREE:22,JOIN:23,QUIT:24},_={provide:function(){return{closeGoodsPop:this.closeGoodsPop}},components:{"foot-more":d,"car-list":l,"show-image":f},data:function(){return{headAttr:{top:0},footHidden:!1,roomInput:"",messages:[],roomCoin:"平台依法对直播内容进行24小时巡查,倡导绿色直播,维护网络文明健康。切勿与他人私下交易,非官方活动谨慎参与,避免上当受骗。",tolast:"",share_status:!1,carVisible:!1,moreVisible:!1,OBSVisible:!1,MEIVisible:!1,pusherMirror:!1,beauty:1,whiteness:2,pro1:0,pro2:0,buyVisible:!1,userOn:!1,goodsInfo:{},coinList:["平台依法对直播内容进行24小时巡查,倡导绿色直播,维护网络文化，定期检查"],curTime:"00:00:00",tlive:!1,startBtn:!0,pushURL:"",usingCamera:"front",enable_mic:!0,praiseCount:0,countDown:5,liveRoomStatus:0,liveStatusStr:"直播未开始",banShare:!1,liveInfo:{},all_sets:{},audience_view:201,audience_online:201,pusherContext:null,netstatusInfo:{},goodsList:[],liveID:"",join_stor_msg:""}},onLoad:function(){var t=this;e.getSystemInfo({success:function(e){t.windowHeight=e.windowHeight}}),e.getStorageSync("userInfo")&&(this.userInfo=JSON.parse(e.getStorageSync("userInfo")),this.roomId=this.userInfo.shop_id,this.liveID=this.userInfo.shop_id)},onReady:function(){var t=this;this.previewPush(),getApp().msgCache=[],getApp().curMsgIndex=0,this.getRoomData(this.userInfo.shop_id);var o=wx.getStorageSync("tlive");o&&(this.tlive=!0);var n={shop_id:this.liveID};(0,s.roomGoodsApi)(n).then((function(e){console.log("直播间商品",e),t.goodsList=e.list})),wx.getImageInfo({src:"https://mp.starfox.cn:9008/api/master/user/genQrCode",success:function(t){e.setStorageSync("qrCode",t.path)}})},created:function(){this.setHeight(),this.headAttr=e.getMenuButtonBoundingClientRect(),this.loginAction()},methods:u({},(0,n.mapActions)(["loginAction"]),{show_share_pic:function(){this.share_status=!this.share_status},copy:function(){var t=this.pushURL;e.setClipboardData({data:t})},showProductList:function(){0==this.goodsList.length?e.showToast({title:"暂无商品",icon:"none"}):this.carVisible=!0},close_share_image:function(){this.share_status=!1},moreTap:function(e,t){1==e?this.pusherMirror=!this.pusherMirror:3==e&&this.banSharef()},slideChange:function(e){var t=e.currentTarget.id;"prog1"==t?(this.pro1=e.detail.value,this.beauty=.1*e.detail.value):(this.pro2=e.detail.value,this.whiteness=.1*e.detail.value)},meiReset:function(){this.beauty=0,this.pro1=0,this.pro2=0,this.whiteness=0},editRoom:function(){e.navigateTo({url:"/pagesB/pages/createLive/editRoom?shop_id="+this.liveID})},OBS:function(){""!=this.pushURL?(this.OBSVisible=!0,this.moreVisible=!1):e.showToast({title:"房间暂未创建",icon:"none"})},getRoomData:function(t){var o=this;if(t>0){var n={shop_id:this.userInfo.shop_id};(0,s.enterRoom)(n).then((function(t){console.log("enterRoom_res",t),o.liveInfo=t;var n={parentId:t.parent_id,IMaccess_token:t.im_access_token,password:t.password,spaceId:t.shop_id,spaceName:t.live_title,rtmpPlayUrl:t.live_url,avatarUrl:t.avatar,liveTitle:t.live_title},s="";try{s=JSON.parse(t.live_cover)[0].cover}catch(r){e.showToast({title:"直播间未认证或者 没有上传分享图",icon:"none"})}o.all_sets=n,o.loadingBg=s,o.parentId=t.parent_id,o.title=t.live_title,o.cover=s,o.startTime=0;var i=o;getApp().im?i.liveInfo.parent_id&&i.liveInfo.parent_id>0?getApp().im.enterRoom(i.liveInfo.parent_id):getApp().im.enterRoom(i.roomId):i.startConnect(i.all_sets.IMaccess_token,i.roomId)}))}},sendMsg:function(){this.roomInput?(this._sendMessage(this.roomInput),this.roomInput="",this.scrollToBottom()):this.$toast("发送文字不能为空"),this.footHidden=!1},banSharef:function(){var t=this;t.banShare=!t.banShare,t.banShare?e.showToast({title:"设置成功，观众当前不能再转发此直播间",icon:"none",duration:2500}):e.showToast({title:"设置成功，观众当前可转发此直播间",icon:"none",duration:2500}),t.sendWSCmd(v.BANSHARE)},scrollToBottom:function(){this.tolast="item"+this.messages.length},addGoods:function(){this.carVisible=!1,this.buyVisible=!1},closeRoom:function(){this.stop()},closeGoodsPop:function(){this.carVisible=!1,this.buyVisible=!1},error:function(e){},statechange:function(e){},startLive:function(){this.liveStatusStr="创建房间...",this.tlive||this.createRoom()},createRoom:function(){var t=this;0!=this.loadingBg.length?(0,s.creatRoom)().then((function(e){console.log("创建房间",e),t.startBtn=!1,t.pushURL=e.pushURL,t.liveStatusStr="准备...",t.liveRoomStatus=1,t.handleCountDown()})):e.showToast({title:"直播间未认证或者 没有上传分享图",icon:"none"})},startConnect:function(e,t){var o=this,n=this;function s(e){var t=parseInt(e.cmdId),o=JSON.parse(e.message);if(t==v.VOTE)this.audience_vote=n.audience_vote+o.voteNum;else if(t==v.PICS);else if(t==v.LIKE)n.addCustomMessage({url:"entry-room-steamer-info",show_message:e.nickName+": 关注了主播",total_time:2});else if(t==v.ADDCART)n.addCustomMessage({url:"live-room-goods-addcar-info",show_message:e.nickName+": 加入了购物车",total_time:2});else if(t==v.PAYOK)n.addCustomMessage({url:"live-room-goods-addorder-info",show_message:e.nickName+": 购买了商品",total_time:2});else if(t==v.SHAREROOM)n.addCustomMessage({url:"live-room-share",show_message:e.nickName+": 分享了直播间",total_time:2});else if(t==v.CREATEORDER)n.addCustomMessage({url:"live-room-goods-addorder-info",show_message:e.nickName+": 开始下单",total_time:2});else if(t==v.JOIN){console.log("t-messages",n.messages);var s=e.nickName+": 加入了直播间";if(s==n.join_stor_msg)return;n.join_stor_msg=s,n.addMessage({msgIndex:0,headimg:"",nickname:e.nickName+": ",message:"加入了直播间"}),n.audience_view=n.audience_view+1,n.audience_online=n.audience_online+1}else t==v.QUIT&&(n.audience_online=n.audience_online-1)}console.log("开启连接方法",e,t);var r="ws.starfox.cn",a=new i.default(r,9003);a.protocol="wss://";var u={handleRoomMessage:function(e){var t="主播",o=JSON.parse(e.content);console.log("接收消息",e),o.cmdId?s(o):(console.log("addM5"),n.addMessage({msgIndex:0,is_anchor:o.isMaster,actor:t,headimg:"",nickname:o.nickName+": ",message:o.message}))},onConnectState:function(e){var t=o;e==i.default.STATE_CONNECTED?(t.sendWSCmd(v.JOIN),console.log("im connected")):e==i.default.STATE_CONNECTING?console.log("im connecting"):e==i.default.STATE_CONNECTFAIL?console.log("im connect fail"):e==i.default.STATE_UNCONNECTED&&console.log("im unconnected")}};a.host=r,a.observer=u,a.accessToken=e,a.start(),console.log("parentId=",n.liveInfo.parent_id,"roomId=",t),n.liveInfo.parent_id&&n.liveInfo.parent_id>0?(console.log("转播-加入转播间"),a.enterRoom(n.liveInfo.parent_id)):(console.log("进入直播间"),a.enterRoom(t)),getApp().im=a},netstatus:function(e){this.netstatusInfo=e},switchCamera:function(){var e=this;e.pusherContext&&e.pusherContext.switchCamera({success:function(e){},fail:function(e){}});var t=e.usingCamera?"front":"back";this.usingCamera=t,"back"==t&&(e.usingCamera="front")},sendWSCmd:function(e){var t=this,o={cmdId:111};e==v.TIPS?o=this.mprData:e==v.PICS?o=this.barCodeImg:e==v.BANSHARE?o={cmd:this.banShare}:e==v.MSGOPEN?o={cmd:this.discussOpenStatus}:e==v.PASSWD?o={password:this.all_sets?this.all_sets.password:""}:e==v.LIVERESUME?o={cmd:!0}:e==v.LIVEPASUE?o={cmd:!0}:e==v.LIVEEND?o={cmd:!0,liveTime:t.curTime,praiseCount:t.audience_vote,userCount:t.audience_view}:e==v.LIVEOPEN&&(o={cmd:!0});var n={appId:t.userInfo.shop_id,userId:t.userInfo.user_id,nickName:t.userInfo.nick_name,whoCanSee:t.getMsgScope(1,e),cmdId:e,message:JSON.stringify(o)},s=getApp().im,r=JSON.stringify(n),a={sender:t.userInfo.user_id,receiver:t.userInfo.shop_id,content:r};t.liveInfo.parent_id&&t.liveInfo.parent_id>0&&(a={sender:t.userInfo.user_id,receiver:t.liveInfo.parent_id,content:r}),s&&s.connectState==i.default.STATE_CONNECTED&&s.sendRoomMessage(a)},_sendMessage:function(e){var t=this,o=getApp().im,n={appId:t.userInfo.shop_id,userId:t.userInfo.user_id,nickName:t.userInfo.nick_name,parentId:t.liveInfo.parent_id,spaceName:t.liveInfo.parent_id?t.all_sets.spaceName:"",message:e,whoCanSee:t.getMsgScope(0),isMaster:1},s=JSON.stringify(n),r={sender:t.userInfo.user_id,receiver:t.userInfo.shop_id,content:s};t.liveInfo.parent_id&&t.liveInfo.parent_id>0&&(r={sender:t.userInfo.user_id,receiver:t.liveInfo.parent_id,content:s}),o.connectState==i.default.STATE_CONNECTED&&o.sendRoomMessage(r),this.inputInfo="",this.inputModalVisible=!1,t.addMessage({msgIndex:0,is_anchor:1,actor:"自己",headimg:t.userInfo.avatarUrl,nickname:t.userInfo.nick_name+": ",message:e})},addMessage:function(e){this.messages.push(e),this._updateMsg(),this.scrollToBottom()},addCustomMessage:function(e){var t=this;console.log("addCustom",e);var o=e.show_message,n=(e.total_time,e.member_num),s=e.praise_count;n&&n>this.userCount&&s&&s>this.praiseCount&&o&&!this.showUserActionTips?(this.userCount=n,this.manualPraise=!1,this.praiseCount=1,[{url:"live-room-follow-steamer-info",type:"coming"},{url:"entry-room-steamer-info",type:"follow"},{url:"live-room-goods-addorder-info",type:"buy"},{url:"live-room-goods-addcar-info",type:"cart"},{url:"live-room-share",type:"share"}].map((function(n){if(e.url===n.url){var s=n;s.message=o,t.userActionTips=s,t.showUserActionTips=!0,setTimeout((function(){t.showUserActionTips=!1}));var i={msgIndex:++getApp().curMsgIndex,is_anchor:e.isMaster||0,headimg:"",nickname:o,message:""};getApp().msgCache.push(i),this._updateMsg()}else console.log("o-url=",e.url,"t-url=",n.url)}))):console.log("无法添加自定义消息")},_updateMsg:function(){var e=this,t=this;return console.log("更新消息",t.messages.length,t.messages),new Promise((function(o){if(!t.messages.length)return o();if(t.messages.length>=100){var n=e.messages.splice(1,50);e.messages=n}o()}))},getMsgScope:function(e,t){return e?t==v.JOIN||t==v.QUIT?g.SELFROOMUPPER:g.ONLYUPPER:g.EVERYONE},handleCountDown:function(){var e=this,t=this.countDown;e.timeId=setInterval((function(o){t--,0==t&&(e.pusherContext&&e.pusherContext.start(),e.startTimerLive(),e.liveStatusStr="直播中...",e.liveRoomStatus=2,setTimeout((function(){e.liveRoomStatus=3}),1e3),e.sendWSCmd(v.LIVEOPEN)),e.countDown=t,t<=0&&clearInterval(e.timeId)}),1e3)},stop:function(){var t=this;e.showModal({title:"提示",confirmText:"继续直播",cancelText:"结束直播",content:"是否结束本次直播，再次直播需另行创建，确认结束吗？",success:function(o){if(o.confirm){t.pusherContext.stop({success:function(e){console.log("监听结束",e)}});var n=t.members;n&&n.forEach((function(e){e.context&&e.context.stop()})),t.unload=1,t.members=[{}],t.visualPlayer=[],t.pusherContext=null,t.playerContext=null,t.linkedPlayerContext=null,t.isCasting=!1}else e.navigateBack({})}})},startTimerLive:function(){var e=this;setInterval((function(){var t,o,n;p++,p>59&&(p=0,m++,m>59&&(m=0,h++)),t=p<10?"0"+p:p,n=m<10?"0"+m:m,o=h<10?"0"+h:h,e.curTime=o+":"+n+":"+t}),1e3)},previewPush:function(){var t=e.createLivePusherContext("livePusher",this);this.pusherContext=t,t.startPreview({success:function(){},fail:function(){},complete:function(){}})}})};t.default=_}).call(this,o("543d")["default"])},5528:function(e,t,o){"use strict";var n=o("9865"),s=o.n(n);s.a},9865:function(e,t,o){},a62e:function(e,t,o){"use strict";(function(e){o("6089");n(o("66fd"));var t=n(o("cb46"));function n(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,o("543d")["createPage"])},be80:function(e,t,o){"use strict";o.r(t);var n=o("4d15"),s=o.n(n);for(var i in n)"default"!==i&&function(e){o.d(t,e,(function(){return n[e]}))}(i);t["default"]=s.a},cb46:function(e,t,o){"use strict";o.r(t);var n=o("0d61"),s=o("be80");for(var i in s)"default"!==i&&function(e){o.d(t,e,(function(){return s[e]}))}(i);o("5528");var r,a=o("f0c5"),u=Object(a["a"])(s["default"],n["b"],n["c"],!1,null,"04efea9e",null,!1,n["a"],r);t["default"]=u.exports}},[["a62e","common/runtime","common/vendor"]]]);